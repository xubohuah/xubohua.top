<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Diff算法 | xu-web</title>
    <meta name="description" content="by xubohua">
    <link rel="stylesheet" href="/assets/style.a8419a3e.css">
    <link rel="modulepreload" href="/assets/app.48148ea1.js">
    <link rel="modulepreload" href="/assets/interview_diff.md.edb6cb89.lean.js">
    
    <link rel="icon" href="https://s1.imgbed.xyz/2022/09/09/gvRrD.png">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-ca9ccb7e><!--[--><!--]--><!--[--><span tabindex="-1" data-v-151f2593></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-151f2593> Skip to content </a><!--]--><!----><header class="VPNav" data-v-ca9ccb7e data-v-a71a30f1><div class="VPNavBar has-sidebar" data-v-a71a30f1 data-v-a35e6f52><div class="container" data-v-a35e6f52><div class="VPNavBarTitle has-sidebar" data-v-a35e6f52 data-v-d5925166><a class="title" href="/" data-v-d5925166><!--[--><!--]--><!--[--><img class="VPImage logo" src="https://img-blog.csdnimg.cn/be87a65842924af38db2238ee909546e.png" data-v-e13a1912><!--]--><!--[--> <!--]--><!--[--><!--]--></a></div><div class="content" data-v-a35e6f52><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-a35e6f52 data-v-f83db6ba><span id="main-nav-aria-label" class="visually-hidden" data-v-f83db6ba>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->首页<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/web/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->web<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/interview/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->interview<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/React/" data-v-f83db6ba data-v-47a2263e data-v-3c355974><!--[-->React<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-a35e6f52 data-v-a3e7452b><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-a3e7452b data-v-968780f1 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-968780f1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-968780f1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-a35e6f52 data-v-738bef5a data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/xubohuah" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-a35e6f52 data-v-e89b88d7 data-v-6ffb57d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-6ffb57d3><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-6ffb57d3><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-6ffb57d3><div class="VPMenu" data-v-6ffb57d3 data-v-1c5d0cfc><!----><!--[--><!--[--><!----><div class="group" data-v-e89b88d7><div class="item appearance" data-v-e89b88d7><p class="label" data-v-e89b88d7>Appearance</p><div class="appearance-action" data-v-e89b88d7><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-e89b88d7 data-v-968780f1 data-v-086e8519><span class="check" data-v-086e8519><span class="icon" data-v-086e8519><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-968780f1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-968780f1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-e89b88d7><div class="item social-links" data-v-e89b88d7><div class="VPSocialLinks social-links-list" data-v-e89b88d7 data-v-f6988cfb><!--[--><a class="VPSocialLink" href="https://github.com/xubohuah" target="_blank" rel="noopener" data-v-f6988cfb data-v-e57698f6><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a35e6f52 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-ca9ccb7e data-v-aac27d5e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-aac27d5e><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-aac27d5e><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-aac27d5e>Menu</span></button><a class="top-link" href="#" data-v-aac27d5e> Return to top </a></div><aside class="VPSidebar" data-v-ca9ccb7e data-v-f332cb62><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-f332cb62><span class="visually-hidden" id="sidebar-aria-label" data-v-f332cb62> Sidebar Navigation </span><!--[--><div class="group" data-v-f332cb62><section class="VPSidebarGroup" data-v-f332cb62 data-v-2976c796><div class="title" data-v-2976c796><h2 class="title-text" data-v-2976c796>面试</h2><div class="action" data-v-2976c796><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-2976c796><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-2976c796><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-2976c796><!--[--><a class="VPLink link link active" href="/interview/diff.html" data-v-2976c796 data-v-f7e544fc data-v-3c355974><!--[--><span class="link-text" data-v-f7e544fc>diff</span><!----><!--]--><!----></a><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-ca9ccb7e data-v-c95df128><div class="VPDoc has-sidebar has-aside" data-v-c95df128 data-v-f0af2311><div class="container" data-v-f0af2311><div class="aside" data-v-f0af2311><div class="aside-curtain" data-v-f0af2311></div><div class="aside-container" data-v-f0af2311><div class="aside-content" data-v-f0af2311><div class="VPDocAside" data-v-f0af2311 data-v-aea49c31><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline has-outline" data-v-aea49c31 data-v-a3de185c><div class="content" data-v-a3de185c><div class="outline-marker" data-v-a3de185c></div><div class="outline-title" data-v-a3de185c>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-a3de185c><span class="visually-hidden" id="doc-outline-aria-label" data-v-a3de185c> Table of Contents for current page </span><ul class="root" data-v-a3de185c><!--[--><li data-v-a3de185c><a class="outline-link" href="#前言" data-v-a3de185c>前言</a><!----></li><li data-v-a3de185c><a class="outline-link" href="#什么是虚拟dom" data-v-a3de185c>什么是虚拟DOM</a><!----></li><li data-v-a3de185c><a class="outline-link" href="#什么是diff算法" data-v-a3de185c>什么是Diff算法</a><!----></li><li data-v-a3de185c><a class="outline-link" href="#diff算法的原理" data-v-a3de185c>Diff算法的原理</a><!----></li><li data-v-a3de185c><a class="outline-link" href="#用index做key" data-v-a3de185c>用index做key</a><!----></li><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-aea49c31></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-f0af2311><div class="content-container" data-v-f0af2311><!--[--><!--]--><main class="main" data-v-f0af2311><div style="position:relative;" class="vp-doc _interview_diff" data-v-f0af2311><div><h1 id="diff算法" tabindex="-1">Diff算法 <a class="header-anchor" href="#diff算法" aria-hidden="true">#</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-hidden="true">#</a></h2><h2 id="什么是虚拟dom" tabindex="-1">什么是虚拟DOM <a class="header-anchor" href="#什么是虚拟dom" aria-hidden="true">#</a></h2><p>讲<code>Diff算法</code>前，我先给大家讲一讲什么是<code>虚拟DOM</code>吧。这有利于后面大家对<code>Diff算法</code>的理解加深。</p><p><code>虚拟DOM</code>是一个<code>对象</code>，一个什么样的对象呢？<strong>一个用来表示真实DOM的对象</strong>，要记住这句话。我举个例子，请看以下<code>真实DOM</code>：</p><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">id</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;list&quot;</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">class</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;item&quot;</span><span style="color:#C9D1D9;">&gt;哈哈&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">class</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;item&quot;</span><span style="color:#C9D1D9;">&gt;呵呵&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">class</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;item&quot;</span><span style="color:#C9D1D9;">&gt;嘿嘿&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;/</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>对应的<code>虚拟DOM</code>为：</p><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> oldVDOM </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> { </span><span style="color:#8B949E;">// 旧虚拟DOM</span></span>
<span class="line"><span style="color:#C9D1D9;">        tagName: </span><span style="color:#A5D6FF;">&#39;ul&#39;</span><span style="color:#C9D1D9;">, </span><span style="color:#8B949E;">// 标签名</span></span>
<span class="line"><span style="color:#C9D1D9;">        props: { </span><span style="color:#8B949E;">// 标签属性</span></span>
<span class="line"><span style="color:#C9D1D9;">            id: </span><span style="color:#A5D6FF;">&#39;list&#39;</span></span>
<span class="line"><span style="color:#C9D1D9;">        },</span></span>
<span class="line"><span style="color:#C9D1D9;">        children: [ </span><span style="color:#8B949E;">// 标签子节点</span></span>
<span class="line"><span style="color:#C9D1D9;">            {</span></span>
<span class="line"><span style="color:#C9D1D9;">                tagName: </span><span style="color:#A5D6FF;">&#39;li&#39;</span><span style="color:#C9D1D9;">, props: { class: </span><span style="color:#A5D6FF;">&#39;item&#39;</span><span style="color:#C9D1D9;"> }, children: [</span><span style="color:#A5D6FF;">&#39;哈哈&#39;</span><span style="color:#C9D1D9;">]</span></span>
<span class="line"><span style="color:#C9D1D9;">            },</span></span>
<span class="line"><span style="color:#C9D1D9;">            {</span></span>
<span class="line"><span style="color:#C9D1D9;">                tagName: </span><span style="color:#A5D6FF;">&#39;li&#39;</span><span style="color:#C9D1D9;">, props: { class: </span><span style="color:#A5D6FF;">&#39;item&#39;</span><span style="color:#C9D1D9;"> }, children: [</span><span style="color:#A5D6FF;">&#39;呵呵&#39;</span><span style="color:#C9D1D9;">]</span></span>
<span class="line"><span style="color:#C9D1D9;">            },</span></span>
<span class="line"><span style="color:#C9D1D9;">            {</span></span>
<span class="line"><span style="color:#C9D1D9;">                tagName: </span><span style="color:#A5D6FF;">&#39;li&#39;</span><span style="color:#C9D1D9;">, props: { class: </span><span style="color:#A5D6FF;">&#39;item&#39;</span><span style="color:#C9D1D9;"> }, children: [</span><span style="color:#A5D6FF;">&#39;嘿嘿&#39;</span><span style="color:#C9D1D9;">]</span></span>
<span class="line"><span style="color:#C9D1D9;">            },</span></span>
<span class="line"><span style="color:#C9D1D9;">        ]</span></span>
<span class="line"><span style="color:#C9D1D9;">    }</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这时候，我修改一个<code>li标签</code>的文本：</p><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">id</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;list&quot;</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">class</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;item&quot;</span><span style="color:#C9D1D9;">&gt;哈哈&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">class</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;item&quot;</span><span style="color:#C9D1D9;">&gt;呵呵&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">class</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;item&quot;</span><span style="color:#C9D1D9;">&gt;林三心哈哈哈哈哈&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt; // 修改</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;/</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这时候生成的<code>新虚拟DOM</code>为：</p><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> newVDOM </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> { </span><span style="color:#8B949E;">// 新虚拟DOM</span></span>
<span class="line"><span style="color:#C9D1D9;">        tagName: </span><span style="color:#A5D6FF;">&#39;ul&#39;</span><span style="color:#C9D1D9;">, </span><span style="color:#8B949E;">// 标签名</span></span>
<span class="line"><span style="color:#C9D1D9;">        props: { </span><span style="color:#8B949E;">// 标签属性</span></span>
<span class="line"><span style="color:#C9D1D9;">            id: </span><span style="color:#A5D6FF;">&#39;list&#39;</span></span>
<span class="line"><span style="color:#C9D1D9;">        },</span></span>
<span class="line"><span style="color:#C9D1D9;">        children: [ </span><span style="color:#8B949E;">// 标签子节点</span></span>
<span class="line"><span style="color:#C9D1D9;">            {</span></span>
<span class="line"><span style="color:#C9D1D9;">                tagName: </span><span style="color:#A5D6FF;">&#39;li&#39;</span><span style="color:#C9D1D9;">, props: { class: </span><span style="color:#A5D6FF;">&#39;item&#39;</span><span style="color:#C9D1D9;"> }, children: [</span><span style="color:#A5D6FF;">&#39;哈哈&#39;</span><span style="color:#C9D1D9;">]</span></span>
<span class="line"><span style="color:#C9D1D9;">            },</span></span>
<span class="line"><span style="color:#C9D1D9;">            {</span></span>
<span class="line"><span style="color:#C9D1D9;">                tagName: </span><span style="color:#A5D6FF;">&#39;li&#39;</span><span style="color:#C9D1D9;">, props: { class: </span><span style="color:#A5D6FF;">&#39;item&#39;</span><span style="color:#C9D1D9;"> }, children: [</span><span style="color:#A5D6FF;">&#39;呵呵&#39;</span><span style="color:#C9D1D9;">]</span></span>
<span class="line"><span style="color:#C9D1D9;">            },</span></span>
<span class="line"><span style="color:#C9D1D9;">            {</span></span>
<span class="line"><span style="color:#C9D1D9;">                tagName: </span><span style="color:#A5D6FF;">&#39;li&#39;</span><span style="color:#C9D1D9;">, props: { class: </span><span style="color:#A5D6FF;">&#39;item&#39;</span><span style="color:#C9D1D9;"> }, children: [</span><span style="color:#A5D6FF;">&#39;林三心哈哈哈哈哈&#39;</span><span style="color:#C9D1D9;">]</span></span>
<span class="line"><span style="color:#C9D1D9;">            },</span></span>
<span class="line"><span style="color:#C9D1D9;">        ]</span></span>
<span class="line"><span style="color:#C9D1D9;">    }</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这就是咱们平常说的<code>新旧两个虚拟DOM</code>，这个时候的<code>新虚拟DOM</code>是数据的最新状态，那么我们直接拿<code>新虚拟DOM</code>去渲染成<code>真实DOM</code>的话，效率真的会比直接操作真实DOM高吗？那肯定是不会的，看下图：</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0089a781a80244308472447b86cad21e~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-07 下午10.24.17.png"></p><p>由上图，一看便知，肯定是第2种方式比较快，因为第1种方式中间还夹着一个<code>虚拟DOM</code>的步骤，所以<strong>虚拟DOM比真实DOM快</strong>这句话其实是错的，或者说是不严谨的。那正确的说法是什么呢？<strong>虚拟DOM算法操作真实DOM，性能高于直接操作真实DOM</strong>，<code>虚拟DOM</code>和<code>虚拟DOM算法</code>是两种概念。<code>虚拟DOM算法 = 虚拟DOM + Diff算法</code></p><h2 id="什么是diff算法" tabindex="-1">什么是Diff算法 <a class="header-anchor" href="#什么是diff算法" aria-hidden="true">#</a></h2><p>上面咱们说了<code>虚拟DOM</code>，也知道了只有<code>虚拟DOM + Diff算法</code>才能真正的提高性能，那讲完<code>虚拟DOM</code>，我们再来讲讲<code>Diff算法</code>吧，还是上面的例子(这张图被压缩的有点小，大家可以打开看，比较清晰)：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c57a7b4e91a4a359474fb4c281f6d8e~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-07 下午10.59.31.png"></p><p>上图中，其实只有一个li标签修改了文本，其他都是不变的，所以没必要所有的节点都要更新，只更新这个li标签就行，Diff算法就是查出这个li标签的算法。</p><p>总结：<strong>Diff算法是一种对比算法</strong>。对比两者是<code>旧虚拟DOM和新虚拟DOM</code>，对比出是哪个<code>虚拟节点</code>更改了，找出这个<code>虚拟节点</code>，并只更新这个虚拟节点所对应的<code>真实节点</code>，而不用更新其他数据没发生改变的节点，实现<code>精准</code>地更新真实DOM，进而<code>提高效率</code>。</p><p><code>使用虚拟DOM算法的损耗计算</code>： 总损耗 = 虚拟DOM增删改+（与Diff算法效率有关）真实DOM差异增删改+（较少的节点）排版与重绘</p><p><code>直接操作真实DOM的损耗计算</code>： 总损耗 = 真实DOM完全增删改+（可能较多的节点）排版与重绘</p><h2 id="diff算法的原理" tabindex="-1">Diff算法的原理 <a class="header-anchor" href="#diff算法的原理" aria-hidden="true">#</a></h2><h3 id="diff同层对比" tabindex="-1">Diff同层对比 <a class="header-anchor" href="#diff同层对比" aria-hidden="true">#</a></h3><p>新旧虚拟DOM对比的时候，Diff算法比较只会在同层级进行, 不会跨层级比较。 所以Diff算法是:<code>深度优先算法</code>。 时间复杂度:<code>O(n)</code></p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ca3d338e5a445ab80e40042c50ac79a~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 上午11.32.47.png"></p><h3 id="diff对比流程" tabindex="-1">Diff对比流程 <a class="header-anchor" href="#diff对比流程" aria-hidden="true">#</a></h3><p>当数据改变时，会触发<code>setter</code>，并且通过<code>Dep.notify</code>去通知所有<code>订阅者Watcher</code>，订阅者们就会调用<code>patch方法</code>，给真实DOM打补丁，更新相应的视图。对于这一步不太了解的可以看一下我之前写<a href="https://juejin.cn/column/6969563635194527758" target="_blank" rel="noreferrer">Vue源码系列</a></p><p><code>newVnode和oldVnode</code>：同层的新旧虚拟节点 <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1db54647698e4c76b6fc38a02067ad72~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 上午11.49.38.png"></p><h3 id="patch方法" tabindex="-1">patch方法 <a class="header-anchor" href="#patch方法" aria-hidden="true">#</a></h3><p>这个方法作用就是，对比当前同层的虚拟节点是否为同一种类型的标签<code>(同一类型的标准，下面会讲)</code>：</p><ul><li>是：继续执行<code>patchVnode方法</code>进行深层比对</li><li>否：没必要比对了，直接整个节点替换成<code>新虚拟节点</code></li></ul><p>来看看<code>patch</code>的核心原理代码</p><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#FF7B72;">function</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">patch</span><span style="color:#C9D1D9;">(</span><span style="color:#FFA657;">oldVnode</span><span style="color:#C9D1D9;">, </span><span style="color:#FFA657;">newVnode</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#8B949E;">// 比较是否为一个类型的节点</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (</span><span style="color:#D2A8FF;">sameVnode</span><span style="color:#C9D1D9;">(oldVnode, newVnode)) {</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#8B949E;">// 是：继续进行深层比较</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#D2A8FF;">patchVnode</span><span style="color:#C9D1D9;">(oldVnode, newVnode)</span></span>
<span class="line"><span style="color:#C9D1D9;">  } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#8B949E;">// 否</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">const</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">oldEl</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldVnode.el </span><span style="color:#8B949E;">// 旧虚拟节点的真实DOM节点</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">const</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">parentEle</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> api.</span><span style="color:#D2A8FF;">parentNode</span><span style="color:#C9D1D9;">(oldEl) </span><span style="color:#8B949E;">// 获取父节点</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#D2A8FF;">createEle</span><span style="color:#C9D1D9;">(newVnode) </span><span style="color:#8B949E;">// 创建新虚拟节点对应的真实DOM节点</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (parentEle </span><span style="color:#FF7B72;">!==</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      api.</span><span style="color:#D2A8FF;">insertBefore</span><span style="color:#C9D1D9;">(parentEle, vnode.el, api.</span><span style="color:#D2A8FF;">nextSibling</span><span style="color:#C9D1D9;">(oEl)) </span><span style="color:#8B949E;">// 将新元素添加进父元素</span></span>
<span class="line"><span style="color:#C9D1D9;">      api.</span><span style="color:#D2A8FF;">removeChild</span><span style="color:#C9D1D9;">(parentEle, oldVnode.el)  </span><span style="color:#8B949E;">// 移除以前的旧元素节点</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#8B949E;">// 设置null，释放内存</span></span>
<span class="line"><span style="color:#C9D1D9;">      oldVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span></span>
<span class="line"><span style="color:#C9D1D9;">    }</span></span>
<span class="line"><span style="color:#C9D1D9;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">return</span><span style="color:#C9D1D9;"> newVnode</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="samevnode方法" tabindex="-1">sameVnode方法 <a class="header-anchor" href="#samevnode方法" aria-hidden="true">#</a></h3><p>patch关键的一步就是<code>sameVnode方法判断是否为同一类型节点</code>，那问题来了，怎么才算是同一类型节点呢？这个<code>类型</code>的标准是什么呢？</p><p>咱们来看看sameVnode方法的核心原理代码，就一目了然了</p><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#FF7B72;">function</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">sameVnode</span><span style="color:#C9D1D9;">(</span><span style="color:#FFA657;">oldVnode</span><span style="color:#C9D1D9;">, </span><span style="color:#FFA657;">newVnode</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">return</span><span style="color:#C9D1D9;"> (</span></span>
<span class="line"><span style="color:#C9D1D9;">    oldVnode.key </span><span style="color:#FF7B72;">===</span><span style="color:#C9D1D9;"> newVnode.key </span><span style="color:#FF7B72;">&amp;&amp;</span><span style="color:#C9D1D9;"> </span><span style="color:#8B949E;">// key值是否一样</span></span>
<span class="line"><span style="color:#C9D1D9;">    oldVnode.tagName </span><span style="color:#FF7B72;">===</span><span style="color:#C9D1D9;"> newVnode.tagName </span><span style="color:#FF7B72;">&amp;&amp;</span><span style="color:#C9D1D9;"> </span><span style="color:#8B949E;">// 标签名是否一样</span></span>
<span class="line"><span style="color:#C9D1D9;">    oldVnode.isComment </span><span style="color:#FF7B72;">===</span><span style="color:#C9D1D9;"> newVnode.isComment </span><span style="color:#FF7B72;">&amp;&amp;</span><span style="color:#C9D1D9;"> </span><span style="color:#8B949E;">// 是否都为注释节点</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#D2A8FF;">isDef</span><span style="color:#C9D1D9;">(oldVnode.data) </span><span style="color:#FF7B72;">===</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">isDef</span><span style="color:#C9D1D9;">(newVnode.data) </span><span style="color:#FF7B72;">&amp;&amp;</span><span style="color:#C9D1D9;"> </span><span style="color:#8B949E;">// 是否都定义了data</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#D2A8FF;">sameInputType</span><span style="color:#C9D1D9;">(oldVnode, newVnode) </span><span style="color:#8B949E;">// 当标签为input时，type必须是否相同</span></span>
<span class="line"><span style="color:#C9D1D9;">  )</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="patchvnode方法" tabindex="-1">patchVnode方法 <a class="header-anchor" href="#patchvnode方法" aria-hidden="true">#</a></h3><p>这个函数做了以下事情：</p><ul><li>找到对应的<code>真实DOM</code>，称为<code>el</code></li><li>判断<code>newVnode</code>和<code>oldVnode</code>是否指向同一个对象，如果是，那么直接<code>return</code></li><li>如果他们都有文本节点并且不相等，那么将<code>el</code>的文本节点设置为<code>newVnode</code>的文本节点。</li><li>如果<code>oldVnode</code>有子节点而<code>newVnode</code>没有，则删除<code>el</code>的子节点</li><li>如果<code>oldVnode</code>没有子节点而<code>newVnode</code>有，则将<code>newVnode</code>的子节点真实化之后添加到<code>el</code></li><li>如果两者都有子节点，则执行<code>updateChildren</code>函数比较子节点，这一步很重要</li></ul><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#FF7B72;">function</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">patchVnode</span><span style="color:#C9D1D9;">(</span><span style="color:#FFA657;">oldVnode</span><span style="color:#C9D1D9;">, </span><span style="color:#FFA657;">newVnode</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">const</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">el</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newVnode.el </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldVnode.el </span><span style="color:#8B949E;">// 获取真实DOM对象</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#8B949E;">// 获取新旧虚拟节点的子节点数组</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">const</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">oldCh</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldVnode.children, </span><span style="color:#79C0FF;">newCh</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newVnode.children</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#8B949E;">// 如果新旧虚拟节点是同一个对象，则终止</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (oldVnode </span><span style="color:#FF7B72;">===</span><span style="color:#C9D1D9;"> newVnode) </span><span style="color:#FF7B72;">return</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#8B949E;">// 如果新旧虚拟节点是文本节点，且文本不一样</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (oldVnode.text </span><span style="color:#FF7B72;">!==</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">&amp;&amp;</span><span style="color:#C9D1D9;"> newVnode.text </span><span style="color:#FF7B72;">!==</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">&amp;&amp;</span><span style="color:#C9D1D9;"> oldVnode.text </span><span style="color:#FF7B72;">!==</span><span style="color:#C9D1D9;"> newVnode.text) {</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#8B949E;">// 则直接将真实DOM中文本更新为新虚拟节点的文本</span></span>
<span class="line"><span style="color:#C9D1D9;">    api.</span><span style="color:#D2A8FF;">setTextContent</span><span style="color:#C9D1D9;">(el, newVnode.text)</span></span>
<span class="line"><span style="color:#C9D1D9;">  } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#8B949E;">// 否则</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (oldCh </span><span style="color:#FF7B72;">&amp;&amp;</span><span style="color:#C9D1D9;"> newCh </span><span style="color:#FF7B72;">&amp;&amp;</span><span style="color:#C9D1D9;"> oldCh </span><span style="color:#FF7B72;">!==</span><span style="color:#C9D1D9;"> newCh) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#8B949E;">// 新旧虚拟节点都有子节点，且子节点不一样</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#8B949E;">// 对比子节点，并更新</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#D2A8FF;">updateChildren</span><span style="color:#C9D1D9;">(el, oldCh, newCh)</span></span>
<span class="line"><span style="color:#C9D1D9;">    } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (newCh) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#8B949E;">// 新虚拟节点有子节点，旧虚拟节点没有</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#8B949E;">// 创建新虚拟节点的子节点，并更新到真实DOM上去</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#D2A8FF;">createEle</span><span style="color:#C9D1D9;">(newVnode)</span></span>
<span class="line"><span style="color:#C9D1D9;">    } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (oldCh) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#8B949E;">// 旧虚拟节点有子节点，新虚拟节点没有</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#8B949E;">//直接删除真实DOM里对应的子节点</span></span>
<span class="line"><span style="color:#C9D1D9;">      api.</span><span style="color:#D2A8FF;">removeChild</span><span style="color:#C9D1D9;">(el)</span></span>
<span class="line"><span style="color:#C9D1D9;">    }</span></span>
<span class="line"><span style="color:#C9D1D9;">  }</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>其他几个点都很好理解，我们详细来讲一下<code>updateChildren</code></p><h3 id="updatechildren方法" tabindex="-1">updateChildren方法 <a class="header-anchor" href="#updatechildren方法" aria-hidden="true">#</a></h3><p>这是<code>patchVnode</code>里最重要的一个方法，新旧虚拟节点的子节点对比，就是发生在<code>updateChildren方法</code>中，接下来就结合一些图来讲，让大家更好理解吧</p><p>是怎么样一个对比方法呢？就是<code>首尾指针法</code>，新的子节点集合和旧的子节点集合，各有首尾两个指针，举个例子：</p><div class="language-html line-numbers-mode"><button class="copy"></button><span class="lang">html</span><pre><code><span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;a&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;b&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;c&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;/</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">修改数据后</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;b&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;c&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;e&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;a&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;/</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>那么新旧两个子节点集合以及其首尾指针为：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3eb33b1b28e7461f9aedb857736a142c~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 下午2.55.26.png"></p><p>然后会进行互相进行比较，总共有五种比较情况：</p><ul><li>1、<code>oldS 和 newS </code>使用<code>sameVnode方法</code>进行比较，<code>sameVnode(oldS, newS)</code></li><li>2、<code>oldS 和 newE </code>使用<code>sameVnode方法</code>进行比较，<code>sameVnode(oldS, newE)</code></li><li>3、<code>oldE 和 newS </code>使用<code>sameVnode方法</code>进行比较，<code>sameVnode(oldE, newS)</code></li><li>4、<code>oldE 和 newE </code>使用<code>sameVnode方法</code>进行比较，<code>sameVnode(oldE, newE)</code></li><li>5、如果以上逻辑都匹配不到，再把所有旧子节点的 <code>key</code> 做一个映射到旧节点下标的 <code>key -&gt; index</code> 表，然后用新 <code>vnode</code> 的 <code>key</code> 去找出在旧节点中可以复用的位置。</li></ul><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/727b5dd8a3424d22afd9dc5cf0dae05e~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 下午2.57.22.png"></p><p><strong>接下来就以上面代码为例，分析一下比较的过程</strong></p><p>分析之前，请大家记住一点，最终的渲染结果都要以newVDOM为准，这也解释了为什么之后的节点移动需要移动到newVDOM所对应的位置</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1efbc4e76c234dccb44cef0a75073d98~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 下午3.03.31.png"></p><ul><li>第一步</li></ul><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#C9D1D9;">oldS </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> a, oldE </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> c</span></span>
<span class="line"><span style="color:#C9D1D9;">newS </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> b, newE </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> a</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>比较结果：<code>oldS 和 newE</code> 相等，需要把<code>节点a</code>移动到<code>newE</code>所对应的位置，也就是末尾，同时<code>oldS++</code>，<code>newE--</code></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7698f560bb44107911585580c241a99~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 下午3.26.25.png"></p><ul><li>第二步</li></ul><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#C9D1D9;">oldS </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> b, oldE </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> c</span></span>
<span class="line"><span style="color:#C9D1D9;">newS </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> b, newE </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> e</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>比较结果：<code>oldS 和 newS</code>相等，需要把<code>节点b</code>移动到<code>newS</code>所对应的位置，同时<code>oldS++</code>,<code>newS++</code></p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1cda8545d6634bcdbf2d007193922092~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 下午3.27.13.png"></p><ul><li>第三步</li></ul><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#C9D1D9;">oldS </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> c, oldE </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> c</span></span>
<span class="line"><span style="color:#C9D1D9;">newS </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> c, newE </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> e</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>比较结果：<code>oldS、oldE 和 newS</code>相等，需要把<code>节点c</code>移动到<code>newS</code>所对应的位置，同时<code>oldS++</code>,<code>newS++</code></p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fdbca1cefdec4ba08637c37a70f26af6~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 下午3.31.48.png"></p><ul><li>第四步 <code>oldS &gt; oldE</code>，则<code>oldCh</code>先遍历完成了，而<code>newCh</code>还没遍历完，说明<code>newCh比oldCh多</code>，所以需要将多出来的节点，插入到真实DOM上对应的位置上</li></ul><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1ec374b664e94888b00721829738ea7a~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 下午3.37.51.png"></p><ul><li>思考题 我在这里给大家留一个思考题哈。上面的例子是<code>newCh比oldCh多</code>，假如相反，是<code>oldCh比newCh多</code>的话，那就是<code>newCh</code>先走完循环，然后<code>oldCh</code>会有多出的节点，结果会在真实DOM里进行删除这些旧节点。大家可以自己思考一下，模拟一下这个过程，像我一样，画图模拟，才能巩固上面的知识。</li></ul><p>附上<code>updateChildren</code>的核心原理代码</p><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#FF7B72;">function</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">updateChildren</span><span style="color:#C9D1D9;">(</span><span style="color:#FFA657;">parentElm</span><span style="color:#C9D1D9;">, </span><span style="color:#FFA657;">oldCh</span><span style="color:#C9D1D9;">, </span><span style="color:#FFA657;">newCh</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> oldStartIdx </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">0</span><span style="color:#C9D1D9;">, newStartIdx </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">0</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> oldEndIdx </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldCh.</span><span style="color:#79C0FF;">length</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">-</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">1</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> oldStartVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldCh[</span><span style="color:#79C0FF;">0</span><span style="color:#C9D1D9;">]</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> oldEndVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldCh[oldEndIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> newEndIdx </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh.</span><span style="color:#79C0FF;">length</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">-</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">1</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> newStartVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[</span><span style="color:#79C0FF;">0</span><span style="color:#C9D1D9;">]</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> newEndVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[newEndIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> oldKeyToIdx</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> idxInOld</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> elmToMove</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">let</span><span style="color:#C9D1D9;"> before</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">while</span><span style="color:#C9D1D9;"> (oldStartIdx </span><span style="color:#FF7B72;">&lt;=</span><span style="color:#C9D1D9;"> oldEndIdx </span><span style="color:#FF7B72;">&amp;&amp;</span><span style="color:#C9D1D9;"> newStartIdx </span><span style="color:#FF7B72;">&lt;=</span><span style="color:#C9D1D9;"> newEndIdx) {</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (oldStartVnode </span><span style="color:#FF7B72;">==</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      oldStartVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldCh[</span><span style="color:#FF7B72;">++</span><span style="color:#C9D1D9;">oldStartIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">    } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (oldEndVnode </span><span style="color:#FF7B72;">==</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      oldEndVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldCh[</span><span style="color:#FF7B72;">--</span><span style="color:#C9D1D9;">oldEndIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">    } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (newStartVnode </span><span style="color:#FF7B72;">==</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      newStartVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[</span><span style="color:#FF7B72;">++</span><span style="color:#C9D1D9;">newStartIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">    } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (newEndVnode </span><span style="color:#FF7B72;">==</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      newEndVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[</span><span style="color:#FF7B72;">--</span><span style="color:#C9D1D9;">newEndIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">    } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (</span><span style="color:#D2A8FF;">sameVnode</span><span style="color:#C9D1D9;">(oldStartVnode, newStartVnode)) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#D2A8FF;">patchVnode</span><span style="color:#C9D1D9;">(oldStartVnode, newStartVnode)</span></span>
<span class="line"><span style="color:#C9D1D9;">      oldStartVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldCh[</span><span style="color:#FF7B72;">++</span><span style="color:#C9D1D9;">oldStartIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">      newStartVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[</span><span style="color:#FF7B72;">++</span><span style="color:#C9D1D9;">newStartIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">    } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (</span><span style="color:#D2A8FF;">sameVnode</span><span style="color:#C9D1D9;">(oldEndVnode, newEndVnode)) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#D2A8FF;">patchVnode</span><span style="color:#C9D1D9;">(oldEndVnode, newEndVnode)</span></span>
<span class="line"><span style="color:#C9D1D9;">      oldEndVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldCh[</span><span style="color:#FF7B72;">--</span><span style="color:#C9D1D9;">oldEndIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">      newEndVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[</span><span style="color:#FF7B72;">--</span><span style="color:#C9D1D9;">newEndIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">    } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (</span><span style="color:#D2A8FF;">sameVnode</span><span style="color:#C9D1D9;">(oldStartVnode, newEndVnode)) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#D2A8FF;">patchVnode</span><span style="color:#C9D1D9;">(oldStartVnode, newEndVnode)</span></span>
<span class="line"><span style="color:#C9D1D9;">      api.</span><span style="color:#D2A8FF;">insertBefore</span><span style="color:#C9D1D9;">(parentElm, oldStartVnode.el, api.</span><span style="color:#D2A8FF;">nextSibling</span><span style="color:#C9D1D9;">(oldEndVnode.el))</span></span>
<span class="line"><span style="color:#C9D1D9;">      oldStartVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldCh[</span><span style="color:#FF7B72;">++</span><span style="color:#C9D1D9;">oldStartIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">      newEndVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[</span><span style="color:#FF7B72;">--</span><span style="color:#C9D1D9;">newEndIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">    } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (</span><span style="color:#D2A8FF;">sameVnode</span><span style="color:#C9D1D9;">(oldEndVnode, newStartVnode)) {</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#D2A8FF;">patchVnode</span><span style="color:#C9D1D9;">(oldEndVnode, newStartVnode)</span></span>
<span class="line"><span style="color:#C9D1D9;">      api.</span><span style="color:#D2A8FF;">insertBefore</span><span style="color:#C9D1D9;">(parentElm, oldEndVnode.el, oldStartVnode.el)</span></span>
<span class="line"><span style="color:#C9D1D9;">      oldEndVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldCh[</span><span style="color:#FF7B72;">--</span><span style="color:#C9D1D9;">oldEndIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">      newStartVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[</span><span style="color:#FF7B72;">++</span><span style="color:#C9D1D9;">newStartIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">    } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#8B949E;">// 使用key时的比较</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (oldKeyToIdx </span><span style="color:#FF7B72;">===</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">undefined</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">        oldKeyToIdx </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">createKeyToOldIdx</span><span style="color:#C9D1D9;">(oldCh, oldStartIdx, oldEndIdx) </span><span style="color:#8B949E;">// 有key生成index表</span></span>
<span class="line"><span style="color:#C9D1D9;">      }</span></span>
<span class="line"><span style="color:#C9D1D9;">      idxInOld </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldKeyToIdx[newStartVnode.key]</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (</span><span style="color:#FF7B72;">!</span><span style="color:#C9D1D9;">idxInOld) {</span></span>
<span class="line"><span style="color:#C9D1D9;">        api.</span><span style="color:#D2A8FF;">insertBefore</span><span style="color:#C9D1D9;">(parentElm, </span><span style="color:#D2A8FF;">createEle</span><span style="color:#C9D1D9;">(newStartVnode).el, oldStartVnode.el)</span></span>
<span class="line"><span style="color:#C9D1D9;">        newStartVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[</span><span style="color:#FF7B72;">++</span><span style="color:#C9D1D9;">newStartIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">      }</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"><span style="color:#C9D1D9;">        elmToMove </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> oldCh[idxInOld]</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (elmToMove.sel </span><span style="color:#FF7B72;">!==</span><span style="color:#C9D1D9;"> newStartVnode.sel) {</span></span>
<span class="line"><span style="color:#C9D1D9;">          api.</span><span style="color:#D2A8FF;">insertBefore</span><span style="color:#C9D1D9;">(parentElm, </span><span style="color:#D2A8FF;">createEle</span><span style="color:#C9D1D9;">(newStartVnode).el, oldStartVnode.el)</span></span>
<span class="line"><span style="color:#C9D1D9;">        } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"><span style="color:#C9D1D9;">          </span><span style="color:#D2A8FF;">patchVnode</span><span style="color:#C9D1D9;">(elmToMove, newStartVnode)</span></span>
<span class="line"><span style="color:#C9D1D9;">          oldCh[idxInOld] </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span></span>
<span class="line"><span style="color:#C9D1D9;">          api.</span><span style="color:#D2A8FF;">insertBefore</span><span style="color:#C9D1D9;">(parentElm, elmToMove.el, oldStartVnode.el)</span></span>
<span class="line"><span style="color:#C9D1D9;">        }</span></span>
<span class="line"><span style="color:#C9D1D9;">        newStartVnode </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[</span><span style="color:#FF7B72;">++</span><span style="color:#C9D1D9;">newStartIdx]</span></span>
<span class="line"><span style="color:#C9D1D9;">      }</span></span>
<span class="line"><span style="color:#C9D1D9;">    }</span></span>
<span class="line"><span style="color:#C9D1D9;">  }</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (oldStartIdx </span><span style="color:#FF7B72;">&gt;</span><span style="color:#C9D1D9;"> oldEndIdx) {</span></span>
<span class="line"><span style="color:#C9D1D9;">    before </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> newCh[newEndIdx </span><span style="color:#FF7B72;">+</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">1</span><span style="color:#C9D1D9;">] </span><span style="color:#FF7B72;">==</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">?</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">null</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">:</span><span style="color:#C9D1D9;"> newCh[newEndIdx </span><span style="color:#FF7B72;">+</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">1</span><span style="color:#C9D1D9;">].el</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#D2A8FF;">addVnodes</span><span style="color:#C9D1D9;">(parentElm, before, newCh, newStartIdx, newEndIdx)</span></span>
<span class="line"><span style="color:#C9D1D9;">  } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (newStartIdx </span><span style="color:#FF7B72;">&gt;</span><span style="color:#C9D1D9;"> newEndIdx) {</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#D2A8FF;">removeVnodes</span><span style="color:#C9D1D9;">(parentElm, oldCh, oldStartIdx, oldEndIdx)</span></span>
<span class="line"><span style="color:#C9D1D9;">  }</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h2 id="用index做key" tabindex="-1">用index做key <a class="header-anchor" href="#用index做key" aria-hidden="true">#</a></h2><p>平常v-for循环渲染的时候，为什么不建议用index作为循环项的key呢？</p><p>我们举个例子，左边是初始数据，然后我在数据前插入一个新数据，变成右边的列表</p><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;                      &lt;</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">key</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;0&quot;</span><span style="color:#C9D1D9;">&gt;a&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;        &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">key</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;0&quot;</span><span style="color:#C9D1D9;">&gt;林三心&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">key</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;1&quot;</span><span style="color:#C9D1D9;">&gt;b&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;        &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">key</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;1&quot;</span><span style="color:#C9D1D9;">&gt;a&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">key</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;2&quot;</span><span style="color:#C9D1D9;">&gt;c&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;        &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">key</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;2&quot;</span><span style="color:#C9D1D9;">&gt;b&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">                              &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">key</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;3&quot;</span><span style="color:#C9D1D9;">&gt;c&lt;/</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;/</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;                     &lt;/</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>按理说，最理想的结果是：只插入一个li标签新节点，其他都不动，确保操作DOM效率最高。但是我们这里用了index来当key的话，真的会实现我们的理想结果吗？废话不多说，实践一下：</p><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">   &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">v-for</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;(item, index) in list&quot;</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA198;">:key=&quot;index&quot;&gt;{{</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA198;">item.title</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA198;">}}&lt;/li&gt;</span></span>
<span class="line"><span style="color:#FFA198;">&lt;/ul&gt;</span></span>
<span class="line"><span style="color:#FFA198;">&lt;button</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA198;">@click=&quot;add&quot;&gt;增加&lt;/button&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFA198;">list:</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA198;">[</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#FF7B72;">{</span><span style="color:#C9D1D9;"> title: </span><span style="color:#A5D6FF;">&quot;a&quot;</span><span style="color:#C9D1D9;">, id: </span><span style="color:#A5D6FF;">&quot;100&quot;</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">}</span><span style="color:#FFA198;">,</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#FF7B72;">{</span><span style="color:#C9D1D9;"> title: </span><span style="color:#A5D6FF;">&quot;b&quot;</span><span style="color:#C9D1D9;">, id: </span><span style="color:#A5D6FF;">&quot;101&quot;</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">}</span><span style="color:#FFA198;">,</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#FF7B72;">{</span><span style="color:#C9D1D9;"> title: </span><span style="color:#A5D6FF;">&quot;c&quot;</span><span style="color:#C9D1D9;">, id: </span><span style="color:#A5D6FF;">&quot;102&quot;</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">}</span><span style="color:#FFA198;">,</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#FFA198;">]</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span></span>
<span class="line"><span style="color:#FFA198;">add()</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">{</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#79C0FF;">this</span><span style="color:#C9D1D9;">.list.</span><span style="color:#D2A8FF;">unshift</span><span style="color:#C9D1D9;">({ title: </span><span style="color:#A5D6FF;">&quot;林三心&quot;</span><span style="color:#C9D1D9;">, id: </span><span style="color:#A5D6FF;">&quot;99&quot;</span><span style="color:#C9D1D9;"> });</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">}</span></span>
<span class="line"><span style="color:#79C0FF;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>点击按钮我们可以看到，并不是我们预想的结果，而是所有li标签都更新了</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44fc88e0125f49328afb321108c72bcd~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="keyindex.gif"></p><p>为什么会这样呢？还是通过图来解释</p><p>按理说，<code>a，b，c</code>三个li标签都是复用之前的，因为他们三个根本没改变，改变的只是前面新增了一个<code>林三心</code></p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f4f0d74d014743a79e11552b0c9351d5~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 下午5.43.25.png"></p><p>但是我们前面说了，在进行子节点的 <code>diff算法</code> 过程中，会进行 旧首节点和新首节点的<code>sameNode</code>对比，这一步命中了逻辑，因为现在<code>新旧两次首部节点</code> 的 <code>key</code> 都是 <code>0</code>了，同理，key为1和2的也是命中了逻辑，导致<code>相同key的节点</code>会去进行<code>patchVnode</code>更新文本，而原本就有的<code>c节点</code>，却因为之前没有key为4的节点，而被当做了新节点，所以很搞笑，使用index做key，最后新增的居然是本来就已有的c节点。所以前三个都进行<code>patchVnode</code>更新文本，最后一个进行了<code>新增</code>，那就解释了为什么所有li标签都更新了。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ecc93fb2bc544a83b8cc7b7cbcaf1857~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 下午5.45.17.png"></p><p>那我们可以怎么解决呢？其实我们只要使用一个独一无二的值来当做key就行了</p><div class="language-js line-numbers-mode"><button class="copy"></button><span class="lang">js</span><pre><code><span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">ul</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">   &lt;</span><span style="color:#7EE787;">li</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">v-for</span><span style="color:#FF7B72;">=</span><span style="color:#A5D6FF;">&quot;item in list&quot;</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA198;">:key=&quot;item.id&quot;&gt;{{</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA198;">item.title</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA198;">}}&lt;/li&gt;</span></span>
<span class="line"><span style="color:#FFA198;">&lt;/ul&gt;</span></span>
<span class="line"><span style="color:#79C0FF;">复制代码</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>现在再来看看效果</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/885269d6d23340f19e9100ec60564173~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="idkey.gif"></p><p>为什么用了id来当做key就实现了我们的理想效果呢，因为这么做的话，<code>a，b，c节点</code>的<code>key</code>就会是永远不变的，更新前后key都是一样的，并且又由于<code>a，b，c节点</code>的内容本来就没变，所以就算是进行了<code>patchVnode</code>，也不会执行里面复杂的更新操作，节省了性能，而林三心节点，由于更新前没有他的key所对应的节点，所以他被当做新的节点，增加到真实DOM上去了。</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/833e0a795a3e4893a0c03bb78a63bffc~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="截屏2021-08-08 下午6.04.34.png"></p></div></div></main><!--[--><!--]--><!----><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-ca9ccb7e data-v-9f24cc86><div class="container" data-v-9f24cc86><p class="message" data-v-9f24cc86>一切足够先进的技术都与魔法无异</p><p class="copyright" data-v-9f24cc86>© 2022-present XU BOHUA</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"react_memoization.md\":\"512494b9\",\"react_weatherreact.md\":\"c287149b\",\"react_index.md\":\"e883341e\",\"react_props daring.md\":\"c46a084a\",\"react_reactpatterns_compoundcomponents.md\":\"b3b9518f\",\"react_reactpatterns_contextmodulefunctions.md\":\"88e7c192\",\"react_redux_toolkit.md\":\"97c7ac0b\",\"react_usecontext -usereducer.md\":\"eb9c245a\",\"react_usereducer-usestate.md\":\"6e04bc75\",\"react_usestate.md\":\"1f897b64\",\"index.md\":\"c0839c24\",\"interview_diff.md\":\"edb6cb89\",\"interview_index.md\":\"f99a7a15\",\"promise.md\":\"4543bd92\",\"web_index.md\":\"2779f7ea\",\"web_js_index.md\":\"931b9ce5\",\"web_js_js.md\":\"64bffb5e\",\"web_js_promise.md\":\"661ea15f\",\"web_js_throttle.md\":\"09c4bde1\",\"web_js_运算符_可选链操作符（.）.md\":\"864ea5f3\",\"web_js_运算符_空值合并运算符（）.md\":\"718dce05\"}")</script>
    <script type="module" async src="/assets/app.48148ea1.js"></script>
    
  </body>
</html>